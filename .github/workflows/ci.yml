name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate-artifacts:
    name: Validate Artifacts (Official Conventions)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run artifact validation
        run: python scripts/ci/validate_artifacts.py

  validate-structure:
    name: Validate Repository Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify required root files
        run: |
          echo "Checking required root files..."
          files=(
            "README.md"
            "LICENSE"
            "SECURITY.md"
            ".gitignore"
            ".editorconfig"
          )
          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              exit 1
            fi
            echo "✅ Found: $file"
          done

      - name: Verify governance docs
        run: |
          echo "Checking governance documentation..."
          docs=(
            "docs/canonical/PROJECT_INSTRUCTIONS.md"
            "docs/canonical/PINNED_PROJECT_PROMPT.md"
            "docs/canonical/VALIDATION_LOG.md"
            "docs/canonical/CHANGELOG.md"
            "docs/architecture/THREAT_MODEL.md"
            "ops/release/RELEASE_CHECKLIST.md"
          )
          for doc in "${docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "❌ Missing governance doc: $doc"
              exit 1
            fi
            echo "✅ Found: $doc"
          done

      - name: Verify official marketplace location
        run: |
          echo "Checking official marketplace location..."
          if [ ! -f ".claude-plugin/marketplace.json" ]; then
            echo "❌ Missing .claude-plugin/marketplace.json"
            exit 1
          fi
          echo "✅ Found: .claude-plugin/marketplace.json"

          if [ ! -f "marketplace/qa/QA_CHECKLIST.md" ]; then
            echo "❌ Missing marketplace/qa/QA_CHECKLIST.md"
            exit 1
          fi
          echo "✅ Found: marketplace/qa/QA_CHECKLIST.md"

      - name: Validate JSON syntax
        run: |
          echo "Validating JSON files..."
          find . -name "*.json" -type f | while read file; do
            if ! python3 -m json.tool "$file" > /dev/null 2>&1; then
              echo "❌ Invalid JSON: $file"
              exit 1
            fi
            echo "✅ Valid JSON: $file"
          done

  validate-plugin:
    name: Validate Claude Code Plugin
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify plugin structure
        run: |
          echo "Checking ninobyte-senior-dev-brain plugin..."
          base="products/claude-code-plugins/ninobyte-senior-dev-brain"

          # Check plugin manifest
          if [ ! -f "$base/.claude-plugin/plugin.json" ]; then
            echo "❌ Missing plugin.json"
            exit 1
          fi
          echo "✅ Found: plugin.json"

          # Check skill
          if [ ! -f "$base/skills/senior-developer-brain/SKILL.md" ]; then
            echo "❌ Missing SKILL.md in plugin"
            exit 1
          fi
          echo "✅ Found: SKILL.md in plugin"

          # Check README and LICENSE
          for file in "README.md" "LICENSE" "CHANGELOG.md"; do
            if [ ! -f "$base/$file" ]; then
              echo "❌ Missing: $base/$file"
              exit 1
            fi
            echo "✅ Found: $base/$file"
          done

      - name: Verify canonical skill
        run: |
          echo "Checking canonical skill..."
          skill="skills/senior-developer-brain/SKILL.md"

          if [ ! -f "$skill" ]; then
            echo "❌ Missing canonical skill: $skill"
            exit 1
          fi
          echo "✅ Found: $skill"

          # Check for YAML frontmatter
          if ! head -1 "$skill" | grep -q "^---"; then
            echo "❌ SKILL.md missing YAML frontmatter"
            exit 1
          fi
          echo "✅ SKILL.md has YAML frontmatter"

      - name: Verify test artifacts
        run: |
          echo "Checking test artifacts..."
          fixtures="skills/senior-developer-brain/tests/fixtures"
          goldens="skills/senior-developer-brain/tests/goldens"

          fixture_count=$(find "$fixtures" -name "*.md" -type f 2>/dev/null | wc -l)
          golden_count=$(find "$goldens" -name "*.md" -type f 2>/dev/null | wc -l)

          if [ "$fixture_count" -lt 1 ]; then
            echo "❌ No test fixtures found"
            exit 1
          fi
          echo "✅ Found $fixture_count fixture files"

          if [ "$golden_count" -lt 1 ]; then
            echo "❌ No golden files found"
            exit 1
          fi
          echo "✅ Found $golden_count golden files"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for potential secrets
        run: |
          echo "Scanning for potential secrets..."

          # Patterns that might indicate secrets
          patterns=(
            "password\s*[:=]"
            "api_key\s*[:=]"
            "secret\s*[:=]"
            "token\s*[:=]"
            "-----BEGIN.*PRIVATE KEY-----"
          )

          for pattern in "${patterns[@]}"; do
            results=$(grep -riE "$pattern" --include="*.md" --include="*.json" --include="*.js" --include="*.ts" --include="*.py" --include="*.yml" --include="*.yaml" . 2>/dev/null | grep -v "placeholder" | grep -v "example" | grep -v "template" | grep -v "SECURITY.md" | grep -v ".gitignore" | grep -v "validate_artifacts.py" || true)
            if [ -n "$results" ]; then
              echo "⚠️ Potential secret pattern found: $pattern"
              echo "$results"
            fi
          done

          echo "✅ Secret scan complete (warnings require manual review)"

      - name: Verify .gitignore includes secret patterns
        run: |
          echo "Checking .gitignore for secret patterns..."
          required_patterns=(
            ".env"
            "*.pem"
            "*.key"
            "credentials"
          )

          for pattern in "${required_patterns[@]}"; do
            if ! grep -q "$pattern" .gitignore; then
              echo "⚠️ .gitignore might be missing pattern: $pattern"
            else
              echo "✅ .gitignore includes: $pattern"
            fi
          done

  context-cleaner-smoke:
    name: ContextCleaner Smoke Harness
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run smoke harness
        run: |
          echo "Running ContextCleaner deterministic smoke harness..."
          echo "This validates JSONL schema v1 contract compliance."
          echo ""
          PYTHONPATH=products/context-cleaner/src python products/context-cleaner/scripts/smoke_context_cleaner.py

      - name: Run pytest (excluding PDF tests - requires optional extras)
        run: |
          pip install pytest
          PYTHONPATH=products/context-cleaner/src python -m pytest products/context-cleaner/tests -v --ignore=products/context-cleaner/tests/test_pdf_extraction.py
