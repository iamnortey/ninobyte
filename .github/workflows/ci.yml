name: CI

# ============================================================================
# Governance Reference:
# This workflow enforces PROJECT_INSTRUCTIONS.md + VALIDATION_LOG.md decisions:
#   - "stdlib-only AirGap" — AirGap tests run in isolated venv with pytest only
#   - "schema v1 contract immutability" — ContextCleaner JSONL output is pinned
#   - "golden snapshot is a gate, not an auto-update" — CI fails on diff, never writes
# ============================================================================

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate-artifacts:
    name: Validate Artifacts (Official Conventions)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install test dependencies (pinned)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install -r requirements-test.txt

      - name: Run artifact validation
        run: python scripts/ci/validate_artifacts.py

      - name: Run pytest (repo root)
        shell: bash
        run: |
          set -euo pipefail
          python -m pytest -q

      - name: Enforce Evidence Integrity
        run: python scripts/ci/validate_evidence_integrity.py

  validate-structure:
    name: Validate Repository Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify required root files
        run: |
          echo "Checking required root files..."
          files=(
            "README.md"
            "LICENSE"
            "SECURITY.md"
            ".gitignore"
            ".editorconfig"
          )
          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              exit 1
            fi
            echo "✅ Found: $file"
          done

      - name: Verify governance docs
        run: |
          echo "Checking governance documentation..."
          docs=(
            "docs/canonical/PROJECT_INSTRUCTIONS.md"
            "docs/canonical/PINNED_PROJECT_PROMPT.md"
            "docs/canonical/VALIDATION_LOG.md"
            "docs/canonical/CHANGELOG.md"
            "docs/architecture/THREAT_MODEL.md"
            "ops/release/RELEASE_CHECKLIST.md"
          )
          for doc in "${docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "❌ Missing governance doc: $doc"
              exit 1
            fi
            echo "✅ Found: $doc"
          done

      - name: Verify official marketplace location
        run: |
          echo "Checking official marketplace location..."
          if [ ! -f ".claude-plugin/marketplace.json" ]; then
            echo "❌ Missing .claude-plugin/marketplace.json"
            exit 1
          fi
          echo "✅ Found: .claude-plugin/marketplace.json"

          if [ ! -f "marketplace/qa/QA_CHECKLIST.md" ]; then
            echo "❌ Missing marketplace/qa/QA_CHECKLIST.md"
            exit 1
          fi
          echo "✅ Found: marketplace/qa/QA_CHECKLIST.md"

      - name: Validate JSON syntax
        run: |
          echo "Validating JSON files..."
          find . -name "*.json" -type f | while read file; do
            if ! python3 -m json.tool "$file" > /dev/null 2>&1; then
              echo "❌ Invalid JSON: $file"
              exit 1
            fi
            echo "✅ Valid JSON: $file"
          done

  validate-plugin:
    name: Validate Claude Code Plugin
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify plugin structure
        run: |
          echo "Checking ninobyte-senior-dev-brain plugin..."
          base="products/claude-code-plugins/ninobyte-senior-dev-brain"

          # Check plugin manifest
          if [ ! -f "$base/.claude-plugin/plugin.json" ]; then
            echo "❌ Missing plugin.json"
            exit 1
          fi
          echo "✅ Found: plugin.json"

          # Check skill
          if [ ! -f "$base/skills/senior-developer-brain/SKILL.md" ]; then
            echo "❌ Missing SKILL.md in plugin"
            exit 1
          fi
          echo "✅ Found: SKILL.md in plugin"

          # Check README and LICENSE
          for file in "README.md" "LICENSE" "CHANGELOG.md"; do
            if [ ! -f "$base/$file" ]; then
              echo "❌ Missing: $base/$file"
              exit 1
            fi
            echo "✅ Found: $base/$file"
          done

      - name: Verify canonical skill
        run: |
          echo "Checking canonical skill..."
          skill="skills/senior-developer-brain/SKILL.md"

          if [ ! -f "$skill" ]; then
            echo "❌ Missing canonical skill: $skill"
            exit 1
          fi
          echo "✅ Found: $skill"

          # Check for YAML frontmatter
          if ! head -1 "$skill" | grep -q "^---"; then
            echo "❌ SKILL.md missing YAML frontmatter"
            exit 1
          fi
          echo "✅ SKILL.md has YAML frontmatter"

      - name: Verify test artifacts
        run: |
          echo "Checking test artifacts..."
          fixtures="skills/senior-developer-brain/tests/fixtures"
          goldens="skills/senior-developer-brain/tests/goldens"

          fixture_count=$(find "$fixtures" -name "*.md" -type f 2>/dev/null | wc -l)
          golden_count=$(find "$goldens" -name "*.md" -type f 2>/dev/null | wc -l)

          if [ "$fixture_count" -lt 1 ]; then
            echo "❌ No test fixtures found"
            exit 1
          fi
          echo "✅ Found $fixture_count fixture files"

          if [ "$golden_count" -lt 1 ]; then
            echo "❌ No golden files found"
            exit 1
          fi
          echo "✅ Found $golden_count golden files"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for potential secrets
        run: |
          echo "Scanning for potential secrets..."

          # Patterns that might indicate secrets
          patterns=(
            "password\s*[:=]"
            "api_key\s*[:=]"
            "secret\s*[:=]"
            "token\s*[:=]"
            "-----BEGIN.*PRIVATE KEY-----"
          )

          for pattern in "${patterns[@]}"; do
            results=$(grep -riE "$pattern" --include="*.md" --include="*.json" --include="*.js" --include="*.ts" --include="*.py" --include="*.yml" --include="*.yaml" . 2>/dev/null | grep -v "placeholder" | grep -v "example" | grep -v "template" | grep -v "SECURITY.md" | grep -v ".gitignore" | grep -v "validate_artifacts.py" || true)
            if [ -n "$results" ]; then
              echo "⚠️ Potential secret pattern found: $pattern"
              echo "$results"
            fi
          done

          echo "✅ Secret scan complete (warnings require manual review)"

      - name: Verify .gitignore includes secret patterns
        run: |
          echo "Checking .gitignore for secret patterns..."
          required_patterns=(
            ".env"
            "*.pem"
            "*.key"
            "credentials"
          )

          for pattern in "${required_patterns[@]}"; do
            if ! grep -q "$pattern" .gitignore; then
              echo "⚠️ .gitignore might be missing pattern: $pattern"
            else
              echo "✅ .gitignore includes: $pattern"
            fi
          done

  context-cleaner-core:
    name: ContextCleaner Core Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run smoke harness
        run: |
          echo "Running ContextCleaner deterministic smoke harness..."
          echo "This validates JSONL schema v1 contract compliance."
          echo ""
          PYTHONPATH=products/context-cleaner/src python products/context-cleaner/scripts/smoke_context_cleaner.py

      - name: Run pytest (PDF tests will skip - no extras installed)
        run: |
          pip install pytest
          PYTHONPATH=products/context-cleaner/src python -m pytest products/context-cleaner/tests -v

  context-cleaner-pdf:
    name: ContextCleaner PDF Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install package with PDF extras
        run: |
          pip install pytest
          pip install -e "products/context-cleaner[pdf]"

      - name: Run smoke harness (with PDF support)
        run: |
          python products/context-cleaner/scripts/smoke_context_cleaner.py

      - name: Run pytest (PDF tests will execute)
        run: |
          python -m pytest products/context-cleaner/tests -v

  context-cleaner-install-editable:
    name: ContextCleaner Install (Editable)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install editable (pip install -e)
        run: |
          pip install -e "products/context-cleaner"

      - name: Verify CLI entrypoint
        run: |
          ninobyte-context-cleaner --version
          context-cleaner --version

      - name: Run contract snapshot check
        run: |
          python products/context-cleaner/scripts/contract_snapshot_check.py

  context-cleaner-install-wheel:
    name: ContextCleaner Install (Wheel)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build wheel
        run: |
          pip install build
          cd products/context-cleaner && python -m build --wheel

      - name: Install wheel
        run: |
          pip install products/context-cleaner/dist/*.whl

      - name: Verify CLI entrypoint
        run: |
          ninobyte-context-cleaner --version
          context-cleaner --version

      - name: Run contract snapshot check
        run: |
          python products/context-cleaner/scripts/contract_snapshot_check.py

  context-cleaner-wheel-audit:
    name: ContextCleaner Wheel Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build sdist and wheel
        run: |
          pip install build
          python -m build products/context-cleaner

      - name: Inspect wheel contents
        run: |
          echo "Inspecting wheel contents..."
          WHEEL=$(ls products/context-cleaner/dist/*.whl)
          echo "Wheel: $WHEEL"
          echo ""

          # List all files in wheel
          python -m zipfile -l "$WHEEL"
          echo ""

          # Verify required modules exist
          echo "Verifying required modules..."
          required_modules=(
            "ninobyte_context_cleaner/__main__.py"
            "ninobyte_context_cleaner/version.py"
            "ninobyte_context_cleaner/redactor.py"
            "ninobyte_context_cleaner/lexicon.py"
            "ninobyte_context_cleaner/table_normalizer.py"
            "ninobyte_context_cleaner/pdf_extractor.py"
          )

          for module in "${required_modules[@]}"; do
            if python -m zipfile -l "$WHEEL" | grep -q "$module"; then
              echo "✅ Found: $module"
            else
              echo "❌ Missing: $module"
              exit 1
            fi
          done

          echo ""
          echo "✅ All required modules present in wheel"

      - name: Install from wheel
        run: |
          pip install products/context-cleaner/dist/*.whl

      - name: Verify CLI entrypoint
        run: |
          ninobyte-context-cleaner --version
          context-cleaner --version

      - name: Run smoke harness
        run: |
          python products/context-cleaner/scripts/smoke_context_cleaner.py

      - name: Run contract snapshot check
        run: |
          python products/context-cleaner/scripts/contract_snapshot_check.py

      - name: Run JSONL consumer compatibility check
        run: |
          cat products/context-cleaner/tests/goldens/contract_snapshot_input.txt | \
            ninobyte-context-cleaner --output-format jsonl | \
            python products/context-cleaner/scripts/jsonl_consumer_check.py

  # ==========================================================================
  # AirGap Isolated Tests (Stdlib-Only Proof)
  # ==========================================================================
  # This job proves AirGap does not require third-party runtime dependencies.
  # It creates a fresh venv with ONLY pytest installed, then runs AirGap tests
  # using PYTHONPATH to reference monorepo sources directly.
  # ==========================================================================
  airgap-isolated-tests:
    name: AirGap Tests (Isolated Stdlib)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Create isolated venv with pytest only
        run: |
          echo "Creating isolated venv to prove AirGap is stdlib-only..."
          python -m venv .venv_airgap
          source .venv_airgap/bin/activate
          pip install -U pip
          pip install pytest
          echo ""
          echo "Installed packages (should only show pytest + deps):"
          pip list
          deactivate

      - name: Run AirGap tests in isolated environment
        run: |
          source .venv_airgap/bin/activate
          echo "Running AirGap tests with PYTHONPATH pointing to monorepo sources..."
          echo "If this fails due to missing imports, AirGap has third-party deps."
          echo ""
          PYTHONPATH=products/mcp-servers/ninobyte-airgap/src:products/context-cleaner/src \
            python -m pytest products/mcp-servers/ninobyte-airgap/tests -v
          deactivate

      - name: Verify no network/shell imports in AirGap adapter
        run: |
          echo "Verifying AirGap adapter security posture..."
          adapter="products/mcp-servers/ninobyte-airgap/src/context_cleaner_adapter.py"

          if grep -q "import subprocess" "$adapter"; then
            echo "❌ FAIL: subprocess import found in adapter"
            exit 1
          fi
          echo "✅ No subprocess imports"

          if grep -q "import socket" "$adapter"; then
            echo "❌ FAIL: socket import found in adapter"
            exit 1
          fi
          echo "✅ No socket imports"

          if grep -q "os.system" "$adapter"; then
            echo "❌ FAIL: os.system found in adapter"
            exit 1
          fi
          echo "✅ No os.system calls"

          echo ""
          echo "✅ AirGap adapter security posture verified"

  # ==========================================================================
  # ContextCleaner Contract Gates
  # ==========================================================================
  # This job enforces Schema v1 immutability. The golden snapshot is a gate,
  # not an auto-update target. Any drift fails CI immediately.
  # ==========================================================================
  context-cleaner-contract-gates:
    name: ContextCleaner Contract Gates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run smoke harness (schema v1 contract)
        run: |
          echo "Running smoke harness for schema v1 contract validation..."
          PYTHONPATH=products/context-cleaner/src \
            python products/context-cleaner/scripts/smoke_context_cleaner.py

      - name: Run contract snapshot check (MUST match exactly)
        run: |
          echo "Running contract snapshot check..."
          echo "This gate fails on any diff. CI never updates the golden."
          echo ""
          PYTHONPATH=products/context-cleaner/src \
            python products/context-cleaner/scripts/contract_snapshot_check.py

      - name: Run JSONL consumer compatibility check
        run: |
          echo "Validating JSONL output against consumer contract..."
          PYTHONPATH=products/context-cleaner/src \
            python products/context-cleaner/scripts/jsonl_consumer_check.py \
            < products/context-cleaner/tests/goldens/contract_snapshot_expected.jsonl

      - name: Verify reserved token protection exists
        run: |
          echo "Verifying reserved token protection pattern..."
          if ! grep -qE '\[A-Z0-9_\]' products/context-cleaner/src/ninobyte_context_cleaner/lexicon.py; then
            echo "❌ FAIL: Reserved token pattern not found"
            exit 1
          fi
          echo "✅ Reserved token protection pattern present"
